<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Exames Sincronizado</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .container { max-width: 900px; }
        .thumbnail { width: 100px; height: 100px; object-fit: cover; border-radius: 0.5rem; border: 2px solid #ddd; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto p-8 bg-white rounded-3xl shadow-xl space-y-6 relative">
        
        <div id="user-profile" class="absolute top-4 right-6 text-right hidden">
            <p class="text-sm text-gray-700">Olá, <strong id="user-name"></strong></p>
            <button id="logout-button" class="text-sm text-blue-600 hover:underline">Sair</button>
        </div>

        <header class="text-center pt-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">Leitor de Exames</h1>
            <p id="subtitle" class="text-gray-600 text-lg md:text-xl">Autenticação necessária para continuar.</p>
        </header>

        <!-- NOVO: Botão Voltar ao Menu Principal -->
        <div class="text-center">
            <a href="index.html" class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-gray-600 hover:bg-gray-700 transition duration-300">
                &larr; Voltar ao Menu Principal
            </a>
        </div>

        <!-- Tela de Login -->
        <div id="login-screen" class="text-center p-8 max-w-md mx-auto">
            <h2 id="auth-title" class="text-2xl font-bold text-gray-800 mb-4">Bem-vindo!</h2>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="E-mail" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                <input type="password" id="login-password" placeholder="Senha" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Entrar</button>
            </form>
            <form id="register-form" class="space-y-4 hidden">
                <input type="email" id="register-email" placeholder="E-mail" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                <input type="password" id="register-password" placeholder="Crie uma senha" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Criar Conta</button>
            </form>
            <p id="auth-error" class="text-red-500 text-sm mt-2"></p>
            <p class="text-sm text-gray-600 mt-4">
                <span id="toggle-text">Não tem uma conta?</span>
                <button id="toggle-auth-mode" class="text-blue-600 hover:underline">Crie uma aqui.</button>
            </p>
            <div class="my-6 flex items-center"><hr class="flex-grow border-t border-gray-300"><span class="px-4 text-gray-500">OU</span><hr class="flex-grow border-t border-gray-300"></div>
            <button id="google-login-button" class="inline-flex items-center gap-3 px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.519-3.357-11.284-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Entrar com o Google
            </button>
        </div>
        
        <!-- Conteúdo Principal da Aplicação (escondido até o login) -->
        <div id="app-content" class="hidden">
            <!-- UPLOADER -->
            <div class="bg-amber-50 p-6 sm:p-8 rounded-2xl shadow-inner border border-amber-200">
                <p class="text-gray-700 mb-6">Selecione uma ou mais imagens, ou um único arquivo PDF. O resultado será salvo na sua conta.</p>
                <div class="flex flex-col space-y-4">
                    <input type="file" id="exam-image-input" accept="image/*, application/pdf" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" multiple>
                    <div id="preview-container" class="mt-4 p-4 border-dashed border-2 border-gray-300 rounded-lg min-h-[120px] hidden flex flex-wrap gap-4 justify-center"></div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="analyze-exam-button" class="w-full p-3 font-semibold text-white bg-amber-600 rounded-lg hover:bg-amber-700" disabled>
                            Analisar e Salvar
                        </button>
                        <button id="clear-selection-button" class="w-full sm:w-auto p-3 font-semibold text-gray-700 bg-gray-300 rounded-lg hover:bg-gray-400 hidden">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÁREA DE RESULTADOS / HISTÓRICO -->
            <div id="result-container" class="mt-8 p-6 bg-green-100 rounded-xl">
                <h3 class="font-bold text-lg mb-2 text-green-900">Último Exame Analisado</h3>
                <p id="progress-text" class="text-gray-600 italic mb-2"></p>
                <div id="transcription-result" class="prose max-w-none whitespace-pre-wrap text-gray-800">
                    Aguardando análise...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // COLE AQUI O SEU OBJETO firebaseConfig
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCBdmvJJgGaZjacG-ro5XsAqUQPxkZ24oo",
  authDomain: "leitor-de-exames-sync.firebaseapp.com",
  projectId: "leitor-de-exames-sync",
  storageBucket: "leitor-de-exames-sync.firebasestorage.app",
  messagingSenderId: "495677306399",
  appId: "1:495677306399:web:1aa9f970091a57846b072a",
  measurementId: "G-9HDX2K2ZZS"
};

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        document.addEventListener('DOMContentLoaded', () => {
            // --- Referências ao DOM ---
            const subtitle = document.getElementById('subtitle');
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');
            const userProfileDiv = document.getElementById('user-profile');
            const userNameSpan = document.getElementById('user-name');
            const googleLoginButton = document.getElementById('google-login-button');
            const logoutButton = document.getElementById('logout-button');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authTitle = document.getElementById('auth-title');
            const toggleText = document.getElementById('toggle-text');
            const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
            const authError = document.getElementById('auth-error');
            const imageInput = document.getElementById('exam-image-input');
            const analyzeButton = document.getElementById('analyze-exam-button');
            const previewContainer = document.getElementById('preview-container');
            const clearSelectionButton = document.getElementById('clear-selection-button');
            const resultContainer = document.getElementById('result-container');
            const transcriptionResult = document.getElementById('transcription-result');
            const progressText = document.getElementById('progress-text');
            
            let currentFiles = [];
            let unsubscribe;
            let currentUser = null;
            let isLoginMode = true;

            // --- LÓGICA DE AUTENTICAÇÃO ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    const displayName = user.displayName || user.email.split('@')[0];
                    userNameSpan.textContent = displayName.split(' ')[0];
                    loginScreen.classList.add('hidden');
                    userProfileDiv.classList.remove('hidden');
                    appContent.classList.remove('hidden');
                    subtitle.textContent = "Capture ou envie seus exames para transcrição.";

                    // CORREÇÃO APLICADA AQUI:
                    // Verifica se há um pedido de redirecionamento após o login.
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectUrl = urlParams.get('redirect');
                    if (redirectUrl) {
                        // Limpa o parâmetro da URL e redireciona
                        window.history.replaceState({}, document.title, window.location.pathname);
                        window.location.href = redirectUrl;
                    } else {
                        listenForLastExam();
                    }
                } else {
                    currentUser = null;
                    loginScreen.classList.remove('hidden');
                    userProfileDiv.classList.add('hidden');
                    appContent.classList.add('hidden');
                    subtitle.textContent = "Autenticação necessária para continuar.";
                    if (unsubscribe) unsubscribe();
                }
            });

            googleLoginButton.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => displayAuthError(error));
            });

            logoutButton.addEventListener('click', () => auth.signOut());

            toggleAuthModeBtn.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                authError.textContent = '';
                if (isLoginMode) {
                    authTitle.textContent = 'Bem-vindo de volta!';
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    toggleText.textContent = 'Não tem uma conta?';
                    toggleAuthModeBtn.textContent = 'Crie uma aqui.';
                } else {
                    authTitle.textContent = 'Crie sua Conta';
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                    toggleText.textContent = 'Já tem uma conta?';
                    toggleAuthModeBtn.textContent = 'Entre aqui.';
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => displayAuthError(error));
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                auth.createUserWithEmailAndPassword(email, password)
                    .catch(error => displayAuthError(error));
            });

            function displayAuthError(error) {
                switch (error.code) {
                    case 'auth/user-not-found': authError.textContent = 'Nenhum usuário encontrado com este e-mail.'; break;
                    case 'auth/wrong-password': authError.textContent = 'Senha incorreta. Tente novamente.'; break;
                    case 'auth/email-already-in-use': authError.textContent = 'Este e-mail já está em uso.'; break;
                    case 'auth/weak-password': authError.textContent = 'Sua senha deve ter pelo menos 6 caracteres.'; break;
                    default: authError.textContent = 'Ocorreu um erro. Tente novamente.';
                }
            }
            
            // --- LÓGICA DA APLICAÇÃO ---
            imageInput.addEventListener('change', handleFileSelect);
            clearSelectionButton.addEventListener('click', clearSelection);
            analyzeButton.addEventListener('click', handleAnalysis);

            function listenForLastExam() {
                if (unsubscribe) unsubscribe();
                if (!currentUser) return;

                const query = db.collection('users').doc(currentUser.uid).collection('exams')
                    .orderBy('timestamp', 'desc')
                    .limit(1);

                unsubscribe = query.onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        transcriptionResult.textContent = "Nenhum exame analisado ainda. Envie um para começar.";
                    } else {
                        const lastExam = snapshot.docs[0].data();
                        transcriptionResult.textContent = lastExam.result;
                    }
                }, error => {
                    console.error("Erro ao buscar último exame:", error);
                    transcriptionResult.textContent = "Não foi possível carregar o último exame.";
                });
            }

            function clearSelection() {
                currentFiles = [];
                previewContainer.innerHTML = '';
                previewContainer.classList.add('hidden');
                analyzeButton.disabled = true;
                clearSelectionButton.classList.add('hidden');
                imageInput.value = '';
            }

            async function handleFileSelect(event) {
                const newFiles = Array.from(event.target.files);
                currentFiles.push(...newFiles);

                if (currentFiles.length > 0) {
                    previewContainer.classList.remove('hidden');
                    analyzeButton.disabled = false;
                    clearSelectionButton.classList.remove('hidden');
                } else {
                    clearSelection();
                    return;
                }
                
                previewContainer.innerHTML = ''; 
                for (const file of currentFiles) {
                    if (file.type.startsWith('image/')) {
                        const thumb = document.createElement('img');
                        thumb.src = URL.createObjectURL(file);
                        thumb.className = 'thumbnail';
                        previewContainer.appendChild(thumb);
                    } else if (file.type === 'application/pdf') {
                        const thumb = document.createElement('div');
                        thumb.className = 'thumbnail flex items-center justify-center bg-red-100 text-red-700';
                        thumb.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd" /></svg>`;
                        previewContainer.appendChild(thumb);
                        if(currentFiles.length > 1) {
                            alert("Não é possível selecionar um PDF junto com outras imagens. A seleção será limpa.");
                            clearSelection();
                            return;
                        }
                    }
                }
            }
            
            async function handleAnalysis() {
                if (currentFiles.length === 0 || !currentUser) return;

                analyzeButton.disabled = true;
                analyzeButton.textContent = 'Processando...';
                progressText.textContent = 'Preparando arquivos...';
                
                let imageParts = [];
                try {
                    for (const file of currentFiles) {
                        if (file.type.startsWith('image/')) {
                            const base64 = await fileToBase64(file);
                            imageParts.push({ mimeType: file.type, data: base64 });
                        } else if (file.type === 'application/pdf') {
                            const typedarray = new Uint8Array(await file.arrayBuffer());
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            for (let i = 1; i <= pdf.numPages; i++) {
                                progressText.textContent = `Processando página ${i} de ${pdf.numPages}...`;
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale: 1.5 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                const base64 = canvas.toDataURL('image/png').split(',')[1];
                                imageParts.push({ mimeType: 'image/png', data: base64 });
                            }
                        }
                    }

                    progressText.textContent = 'Enviando para a inteligência artificial...';

                    const prompt = `
                        Você é um assistente médico para realizar a leitura e transcrição de fotos de exames ou arquivos pdf, visando a extração de dados médicos com foco na precisão das informações lidas. Siga estas regras gerais:
                        1.  **NÃO INVENTE NADA:** Não invente, infira, calcule ou adicione qualquer informação que não esteja visivelmente escrita no exame. A precisão é a prioridade máxima. Não escreva valores de referência como resultado de exame.
                        2.  **SEJA LITERAL:** Transcreva nomes de exames, valores e unidades exatamente como aparecem.
                        3.  **ILEGÍVEL:** Se um valor ou nome de exame não estiver claro ou legível, escreva 'ILEGÍVEL' no lugar do valor.
                        4.  **NÃO FAÇA RESUMOS:** Não forneça resumos, explicações ou conselhos médicos. Apenas extraia os dados.
                        5.  **FORMATAÇÃO:**
                            - Primeiro, encontre e escreva a data do exame no formato: (DD/MM/AAAA). Escreva a data apenas no início do registro dos exames de cada data.
                            - Depois, começando na mesma linha da data, liste cada exame encontrado com seu valor e unidades, em sequencia em uma mesma linha, separando cada exame por uma /. Use o formato: Nome do Exame: [Valor] [Unidade]
                            - Exemplo: Hemoglobina: 14.5 g/dL
                        6.  **INSTRUÇÕES ESPECÍFICAS:**
                            - Para o Hemograma, extraia APENAS os valores de Hemoglobina, Leucócitos e Plaquetas.
                            - Para o exame parcial de urina (quando este estiver presente) anote apenas os itens que apresentarem divergencia com os valores de referencia citados nofornecidos pelo exame.
                            - Agrupe os resultados de colesterol total, colesterol HDL e triglicerídeos dentro do espaço de duas /, listando os mesmos sempre nesta sequencia.
                            - Para exames de imagem (como ultrassom, tomografia), transcreva a seção 'CONCLUSÃO' ou 'IMPRESSÃO DIAGNÓSTICA' palavra por palavra.
                        Consolide os resultados de todas as imagens em uma única resposta, liste primeiro os exames que estiverem com resultados fora dos valores de referência citados no exame.
                    `;
                    
                    const idToken = await currentUser.getIdToken();
                    const response = await fetch('https://magomfc.onrender.com/analyze-exam', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({ prompt, imageParts })
                    });

                    if (!response.ok) throw new Error((await response.json()).error || 'Falha na comunicação com o servidor.');
                    
                    const result = await response.json();
                    progressText.textContent = 'Análise concluída!';
                    clearSelection();

                } catch (error) {
                    progressText.textContent = `Erro: ${error.message}`;
                } finally {
                    analyzeButton.disabled = false;
                    analyzeButton.textContent = 'Analisar e Salvar';
                }
            }

            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = (error) => reject(error);
            });
        });
    </script>
</body>
</html>



