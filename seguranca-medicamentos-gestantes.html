<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segurança de Medicamentos (Gestação e Lactação)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 900px;
        }
        .section-title {
            position: relative;
            padding-bottom: 0.5rem;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background-color: #a855f7; /* Cor roxa */
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto p-8 bg-white rounded-3xl shadow-xl space-y-10">
        <header class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">Segurança de Medicamentos</h1>
            <p class="text-gray-600 text-lg md:text-xl">
                Consulte rapidamente a categoria de risco e resumo de segurança para medicações na gestação e na lactação.
            </p>
        </header>

        <!-- Botão Voltar ao Menu Principal -->
        <div class="text-center mb-8">
            <a href="index.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-300">
                &larr; Voltar ao Menu Principal
            </a>
        </div>

        <!-- Seção de Consulta -->
        <div class="bg-violet-50 p-6 sm:p-8 rounded-2xl shadow-inner border border-violet-200">
            <h2 class="section-title text-2xl font-bold text-violet-900 mb-4">Consultar Medicamento</h2>
            
            <div class="flex flex-col space-y-4">
                <label for="medication-name" class="text-sm font-medium text-gray-700">Nome do Medicamento:</label>
                <input type="text" id="medication-name" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition duration-200" placeholder="Ex: AAS, Losartana, Paracetamol">
            </div>

            <button id="search-medication" class="w-full mt-6 p-3 font-semibold text-white bg-violet-600 rounded-lg hover:bg-violet-700 transition duration-300 shadow-md flex items-center justify-center">
                <span id="button-text">Pesquisar Risco</span>
                <svg id="loading-icon" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>

        <!-- Área de Resultados -->
        <div id="results-area" class="mt-8 p-6 bg-white rounded-2xl shadow-lg border border-gray-200 hidden">
            <h3 class="text-xl font-bold text-violet-800 mb-4">Resultado da Consulta</h3>
            <div id="result-content" class="text-gray-700 space-y-3">
                <!-- Conteúdo do risco (Texto gerado) será inserido aqui -->
            </div>
            <div id="sources-list" class="mt-4 pt-4 border-t border-gray-100 text-sm text-gray-500">
                <!-- Fontes serão listadas aqui -->
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-10">
            <p class="mb-2"><strong>Aviso Legal:</strong> A informação é gerada usando busca na web e IA e deve ser confirmada com fontes médicas oficiais. Esta ferramenta não substitui a consulta profissional.</p>
            <p>&copy; 2024 Ferramentas Médicas. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = "AIzaSyA0meA23e59qUHV24CdZALw5LYHFk4HNwU"; // Será preenchido pelo ambiente
        
        const medicationInput = document.getElementById('medication-name');
        const searchButton = document.getElementById('search-medication');
        const buttonText = document.getElementById('button-text');
        const loadingIcon = document.getElementById('loading-icon');
        const resultsArea = document.getElementById('results-area');
        const resultContent = document.getElementById('result-content');
        const sourcesList = document.getElementById('sources-list');

        let isSearching = false;

        // Função de fetch com espera exponencial para maior resiliência
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        // Rate limit: tenta novamente após um delay maior
                        console.warn(`Tentativa ${i + 1}: Rate limit excedido. Tentando novamente...`);
                    } else if (!response.ok) {
                        // Outros erros HTTP, mas não rate limit. Tenta novamente.
                        console.error(`Tentativa ${i + 1}: Erro HTTP ${response.status}. Tentando novamente...`);
                    } else {
                        // Sucesso
                        return response;
                    }
                } catch (error) {
                    console.error(`Tentativa ${i + 1}: Erro de rede/fetch:`, error);
                }

                if (i < maxRetries - 1) {
                    // Calcula o tempo de espera (2^i * 1000 ms) + um jitter aleatório
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Falha total na comunicação após várias tentativas.");
        }

        // Função principal de busca
        async function searchMedication(medicationName) {
            if (isSearching || !medicationName.trim()) return;

            isSearching = true;
            resultsArea.classList.add('hidden');
            resultContent.innerHTML = '';
            sourcesList.innerHTML = '';

            // 1. Mostrar estado de carregamento
            searchButton.disabled = true;
            buttonText.textContent = 'Pesquisando...';
            loadingIcon.classList.remove('hidden');

            // PROMPT ATUALIZADO PARA INCLUIR LACTAÇÃO
            const systemPrompt = "Você é um especialista em saúde materno-fetal. Para a droga fornecida, encontre e forneça a categoria de risco na gravidez (FDA ou A/B/C/D/X, ou Briggs/ACOG) E a avaliação de segurança para lactação. Forneça um resumo conciso e detalhado em português (em duas seções claras: **Segurança na Gestação** e **Segurança na Lactação**) sobre o uso da droga. Use as informações de busca fornecidas para responder.";
            const userQuery = `Segurança, categoria de risco na gravidez, e segurança na lactação (risco/benefício) para: ${medicationName}.`;


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const url = API_URL + apiKey;
                const response = await exponentialBackoffFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Resposta HTTP não OK: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    // Converte Markdown básico em HTML (negrito e quebras de linha)
                    const htmlText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-violet-700">$1</strong>') // Negrito com cor para destaque
                        .replace(/\n\n/g, '<br><br>') // Parágrafos
                        .replace(/\n/g, '<br>'); // Quebras de linha simples

                    resultContent.innerHTML = htmlText;
                    
                    // 2. Extrair e exibir fontes
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    if (sources.length > 0) {
                        const listHtml = sources.map((s, index) => 
                            `<li class="hover:text-violet-600 transition duration-150 truncate"><a href="${s.uri}" target="_blank" rel="noopener noreferrer" title="${s.title}">${index + 1}. ${s.title}</a></li>`
                        ).join('');
                        sourcesList.innerHTML = `<p class="font-semibold mb-2">Fontes Consultadas:</p><ul class="list-none space-y-1">${listHtml}</ul>`;
                    } else {
                        sourcesList.innerHTML = '<p class="font-semibold">Nenhuma fonte específica encontrada.</p>';
                    }
                    
                    resultsArea.classList.remove('hidden');

                } else {
                    displayError('Não foi possível gerar uma resposta. A estrutura da API pode ter mudado ou a resposta está vazia.');
                }

            } catch (error) {
                console.error("Erro total durante a busca:", error);
                displayError('Erro ao pesquisar: Falha na comunicação. Por favor, tente novamente.');
            } finally {
                // 3. Restaurar estado do botão
                isSearching = false;
                searchButton.disabled = false;
                buttonText.textContent = 'Pesquisar Risco';
                loadingIcon.classList.add('hidden');
            }
        }

        // Função auxiliar para exibir mensagens de erro
        function displayError(message) {
            resultContent.innerHTML = `<p class="text-red-600 font-semibold">${message}</p>`;
            sourcesList.innerHTML = '';
            resultsArea.classList.remove('hidden');
        }

        // Event Listener para o botão
        searchButton.addEventListener('click', () => {
            searchMedication(medicationInput.value);
        });

        // Event Listener para a tecla Enter no input
        medicationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMedication(medicationInput.value);
            }
        });
    </script>
</body>
</html>
